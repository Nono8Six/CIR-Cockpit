import { useForm } from 'react-hook-form';
import { useQueryClient } from '@tanstack/react-query';
import { zodResolver } from '@hookform/resolvers/zod';

import { Channel, type InteractionDraft, type StatusCategory, type Entity, type EntityContact, type UserRole } from '@/types';
import type { AgencyConfig } from '@/services/config';
import { interactionFormSchema, type InteractionFormValues } from '@/schemas/interactionSchema';
import { useSaveClient } from './useSaveClient';
import { useSaveEntityContact } from './useSaveEntityContact';
import { useInteractionDraft } from './useInteractionDraft';
import { useInteractionFormState } from './useInteractionFormState';
import { useInteractionHandlers } from './useInteractionHandlers';
import { useInteractionGateState } from './useInteractionGateState';
import { useInteractionFormEffects } from './useInteractionFormEffects';
import { useKnownCompanies } from './useKnownCompanies';
import { useInteractionFocus } from './useInteractionFocus';
import { useInteractionHotkeys } from './useInteractionHotkeys';
import { useInteractionInvalidHandler } from './useInteractionInvalidHandler';
import { useInteractionStepper } from './useInteractionStepper';
import { useInteractionSubmit } from './useInteractionSubmit';
import { useCockpitDialogsState } from './useCockpitDialogsState';
import { useCockpitDerivedState } from './useCockpitDerivedState';
import { useCockpitFormRefs } from './useCockpitFormRefs';
import { useCockpitRegisterFields } from './useCockpitRegisterFields';
import { useCockpitPaneProps } from './useCockpitPaneProps';

type UseCockpitFormControllerParams = { onSave: (interaction: InteractionDraft) => Promise<boolean>; config: AgencyConfig; activeAgencyId: string | null; userId: string | null; userRole: UserRole; recentEntities?: Entity[]; entitySearchIndex: { entities: Entity[]; contacts: EntityContact[] }; entitySearchLoading: boolean; onOpenGlobalSearch?: () => void };
const DEFAULT_FORM_VALUES: InteractionFormValues = { channel: Channel.PHONE, entity_type: '', contact_service: '', company_name: '', company_city: '', contact_first_name: '', contact_last_name: '', contact_position: '', contact_name: '', contact_phone: '', contact_email: '', subject: '', mega_families: [], status_id: '', interaction_type: '', order_ref: '', reminder_at: '', notes: '', entity_id: '', contact_id: '' };
const STATUS_CATEGORY_BADGES: Record<StatusCategory, string> = { todo: 'bg-red-50 text-red-700 border-red-100', in_progress: 'bg-amber-50 text-amber-700 border-amber-100', done: 'bg-emerald-50 text-emerald-700 border-emerald-100' };
const LABEL_STYLE = 'text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block';
const FOOTER_LABEL_STYLE = 'text-xs font-semibold text-slate-400 uppercase tracking-wide';
const EMPTY_ENTITIES: Entity[] = [];

export const useCockpitFormController = ({ onSave, config, activeAgencyId, userId, userRole, recentEntities = EMPTY_ENTITIES, entitySearchIndex, entitySearchLoading, onOpenGlobalSearch }: UseCockpitFormControllerParams) => {
  const dialogs = useCockpitDialogsState(); const refs = useCockpitFormRefs(); const queryClient = useQueryClient();
  const form = useForm<InteractionFormValues>({ resolver: zodResolver(interactionFormSchema), defaultValues: DEFAULT_FORM_VALUES });
  const formState = useInteractionFormState({ control: form.control, config, activeAgencyId, entitySearchIndex, selectedEntity: dialogs.selectedEntity, selectedContact: dialogs.selectedContact });

  useInteractionFormEffects({ register: form.register, setValue: form.setValue, clearErrors: form.clearErrors, config, relationOptions: formState.relationOptions, defaultStatusId: formState.defaultStatusId, entityType: formState.entityType, statusId: formState.statusId, contactService: formState.contactService, interactionType: formState.interactionType, normalizedRelation: formState.normalizedRelation, selectedEntity: dialogs.selectedEntity, setSelectedEntity: dialogs.setSelectedEntity, setSelectedContact: dialogs.setSelectedContact, entityId: formState.entityId, contactFirstName: formState.contactFirstName, contactLastName: formState.contactLastName, contactName: formState.contactName, isInternalRelation: formState.isInternalRelation, isSolicitationRelation: formState.isSolicitationRelation, onCloseContactDialog: () => dialogs.setIsContactDialogOpen(false) });

  const { knownCompanies, setKnownCompanies } = useKnownCompanies();
  const handlers = useInteractionHandlers({ setValue: form.setValue, clearErrors: form.clearErrors, normalizedRelation: formState.normalizedRelation, contacts: formState.contacts, megaFamilies: formState.megaFamilies, activeAgencyId, queryClient, setSelectedEntity: dialogs.setSelectedEntity, setSelectedContact: dialogs.setSelectedContact, saveClientMutation: useSaveClient(activeAgencyId, false), saveContactMutation: useSaveEntityContact(dialogs.selectedEntity?.id ?? null, false, activeAgencyId), onConvertComplete: dialogs.closeConvertDialog });
  const derived = useCockpitDerivedState({ channel: formState.channel, entityType: formState.entityType, contactService: formState.contactService, interactionType: formState.interactionType, companyName: formState.companyName, companyCity: formState.companyCity, contactFirstName: formState.contactFirstName, contactLastName: formState.contactLastName, contactPosition: formState.contactPosition, contactName: formState.contactName, contactPhone: formState.contactPhone, contactEmail: formState.contactEmail, subject: formState.subject, megaFamilies: formState.megaFamilies, statusId: formState.statusId, orderRef: formState.orderRef, reminderAt: formState.reminderAt, notes: formState.notes, entityId: formState.entityId, contactId: formState.contactId, config, knownCompanies, selectedEntity: dialogs.selectedEntity, isClientRelation: formState.isClientRelation });

  const { handleReset } = useInteractionDraft({ activeAgencyId, userId, defaultValues: DEFAULT_FORM_VALUES, relationOptions: formState.relationOptions, config, defaultStatusId: formState.defaultStatusId, reset: form.reset, setSelectedEntity: dialogs.setSelectedEntity, setSelectedContact: dialogs.setSelectedContact, entities: formState.entities, contacts: formState.contacts, entitySearchLoading, contactsLoading: formState.contactsQuery.isLoading, entityId: formState.entityId, contactId: formState.contactId, selectedEntity: dialogs.selectedEntity, selectedContact: dialogs.selectedContact, draftPayload: derived.draftPayload, hasDraftContent: derived.hasDraftContent });
  const gateState = useInteractionGateState({ channel: formState.channel, entityType: formState.entityType, contactService: formState.contactService, interactionType: formState.interactionType, subject: formState.subject, statusId: formState.statusId, companyName: formState.companyName, companyCity: formState.companyCity, contactFirstName: formState.contactFirstName, contactLastName: formState.contactLastName, contactPosition: formState.contactPosition, contactName: formState.contactName, contactPhone: formState.contactPhone, contactEmail: formState.contactEmail, isClientRelation: formState.isClientRelation, isInternalRelation: formState.isInternalRelation, hasSelectedEntity: Boolean(dialogs.selectedEntity), hasSelectedContact: Boolean(dialogs.selectedContact) });
  const { stepperSteps, currentStepIndex } = useInteractionStepper({ channel: formState.channel, entityType: formState.entityType, companyName: formState.companyName, companyCity: formState.companyCity, contactFirstName: formState.contactFirstName, contactLastName: formState.contactLastName, contactPosition: formState.contactPosition, contactPhone: formState.contactPhone, contactService: formState.contactService, interactionType: formState.interactionType, hasContactMethod: gateState.hasContactMethod, isClientRelation: formState.isClientRelation, isProspectRelation: formState.isProspectRelation, isSupplierRelation: formState.isSupplierRelation, isInternalRelation: formState.isInternalRelation, isSolicitationRelation: formState.isSolicitationRelation, selectedEntity: dialogs.selectedEntity, selectedContact: dialogs.selectedContact });

  const focusCurrentStep = useInteractionFocus({ currentStepIndex, isClientRelation: formState.isClientRelation, selectedEntity: dialogs.selectedEntity, channelButtonRef: refs.channelButtonRef, relationButtonRef: refs.relationButtonRef, interactionTypeRef: refs.interactionTypeRef, companyInputRef: refs.companyInputRef, contactFirstNameInputRef: refs.contactFirstNameInputRef, contactSelectRef: refs.contactSelectRef, searchInputRef: refs.searchInputRef, formRef: refs.formRef });
  const { onSubmit } = useInteractionSubmit({ activeAgencyId, config, selectedEntity: dialogs.selectedEntity, selectedContact: dialogs.selectedContact, onSave, handleSelectEntity: handlers.handleSelectEntity, handleSelectContact: handlers.handleSelectContact, queryClient, setError: form.setError, handleReset, setKnownCompanies });
  const onInvalid = useInteractionInvalidHandler({ setFocus: form.setFocus, searchInputRef: refs.searchInputRef, contactSelectRef: refs.contactSelectRef, statusTriggerRef: refs.statusTriggerRef });
  useInteractionHotkeys({ formRef: refs.formRef, searchInputRef: refs.searchInputRef, setFocus: form.setFocus });

  const registerFields = useCockpitRegisterFields({ register: form.register });
  const paneProps = useCockpitPaneProps({ labelStyle: LABEL_STYLE, footerLabelStyle: FOOTER_LABEL_STYLE, errors: form.formState.errors, setValue: form.setValue, channel: formState.channel, channelButtonRef: refs.channelButtonRef, relationOptions: formState.relationOptions, entityType: formState.entityType, relationButtonRef: refs.relationButtonRef, isInternalRelation: formState.isInternalRelation, isSolicitationRelation: formState.isSolicitationRelation, isClientRelation: formState.isClientRelation, isProspectRelation: formState.isProspectRelation, isSupplierRelation: formState.isSupplierRelation, activeAgencyId, entitySearchIndex, entitySearchLoading, onSelectEntityFromSearch: handlers.handleSelectEntityFromSearch, onSelectContactFromSearch: handlers.handleSelectContactFromSearch, onOpenClientDialog: () => dialogs.setIsClientDialogOpen(true), onOpenGlobalSearch, recentEntities, searchInputRef: refs.searchInputRef, selectedEntity: dialogs.selectedEntity, selectedContact: dialogs.selectedContact, selectedEntityMeta: formState.selectedEntityMeta, selectedContactMeta: formState.selectedContactMeta, canConvertToClient: formState.canConvertToClient, onOpenConvertDialog: dialogs.handleOpenConvertDialog, onClearSelectedEntity: () => handlers.handleSelectEntity(null), onClearSelectedContact: () => handlers.handleSelectContact(null), companyField: registerFields.companyField, companyCityField: registerFields.companyCityField, companyName: formState.companyName, companyCity: formState.companyCity, showSuggestions: dialogs.showSuggestions, onShowSuggestionsChange: dialogs.setShowSuggestions, companySuggestions: derived.companySuggestions, companyInputRef: refs.companyInputRef, contactSelectValue: formState.contactSelectValue, contacts: formState.contacts, contactsLoading: formState.contactsQuery.isLoading, onContactSelect: handlers.handleContactSelect, contactSelectRef: refs.contactSelectRef, onOpenContactDialog: () => dialogs.setIsContactDialogOpen(true), contactFirstNameField: registerFields.contactFirstNameField, contactLastNameField: registerFields.contactLastNameField, contactPositionField: registerFields.contactPositionField, contactPhoneField: registerFields.contactPhoneField, contactEmailField: registerFields.contactEmailField, contactFirstNameInputRef: refs.contactFirstNameInputRef, contactFirstName: formState.contactFirstName, contactLastName: formState.contactLastName, contactPhone: formState.contactPhone, contactEmail: formState.contactEmail, onContactFirstNameChange: handlers.handleContactFirstNameChange, onContactLastNameChange: handlers.handleContactLastNameChange, onContactPhoneChange: handlers.handlePhoneChange, interactionType: formState.interactionType, hasInteractionTypes: formState.hasInteractionTypes, interactionTypeHelpId: formState.interactionTypeHelpId, interactionTypeRef: refs.interactionTypeRef, contactService: formState.contactService, quickServices: derived.quickServices, remainingServices: derived.remainingServices, servicePickerOpen: dialogs.servicePickerOpen, onServicePickerOpenChange: dialogs.setServicePickerOpen, config, subjectField: registerFields.subjectField, notesField: registerFields.notesField, orderRefField: registerFields.orderRefField, reminderField: registerFields.reminderField, reminderAt: formState.reminderAt, megaFamilies: formState.megaFamilies, onToggleFamily: handlers.toggleFamily, statusMeta: formState.statusMeta ?? null, statusCategoryLabel: formState.statusCategoryLabel, statusCategoryBadges: STATUS_CATEGORY_BADGES, statusTriggerRef: refs.statusTriggerRef, statusValue: formState.statusId, onStatusChange: (statusId: string) => { form.setValue('status_id', statusId, { shouldDirty: true, shouldValidate: true }); }, statusGroups: formState.statusGroups, hasStatuses: formState.hasStatuses, statusHelpId: formState.statusHelpId, onSetReminder: handlers.setReminder, onReset: handleReset });

  return { canSave: gateState.canSave, gateMessage: gateState.gateMessage, stepperSteps, formRef: refs.formRef, handleFormSubmit: form.handleSubmit(onSubmit, onInvalid), focusCurrentStep, leftPaneProps: paneProps.leftPaneProps, rightPaneProps: paneProps.rightPaneProps, dialogs: { agencies: formState.agencies, userRole, activeAgencyId, selectedEntity: dialogs.selectedEntity, isClientDialogOpen: dialogs.isClientDialogOpen, isContactDialogOpen: dialogs.isContactDialogOpen, isConvertDialogOpen: dialogs.isConvertDialogOpen, convertTarget: dialogs.convertTarget, onClientDialogChange: dialogs.setIsClientDialogOpen, onContactDialogChange: dialogs.setIsContactDialogOpen, onConvertDialogChange: dialogs.handleConvertDialogChange, onSaveClient: handlers.handleSaveClient, onSaveContact: handlers.handleSaveContact, onConvertClient: handlers.handleConvertClient } };
};
